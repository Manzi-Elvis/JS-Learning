<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple CRUD App</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    form, table { background: #fff; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
    input, button { padding: 8px; margin: 5px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    tr:hover { background-color: #f1f1f1; }
  </style>
</head>
<body>

<h1>Simple CRUD App</h1>

<!-- Create / Update Form -->

<form id="userForm">
  <input type="hidden" id="userId">
  <input type="text" id="firstName" placeholder="First Name" required>
  <input type="text" id="lastName" placeholder="Last Name" required>
  <input type="email" id="email" placeholder="Email" required>
  <input type="password" id="password" placeholder="Password" required>
  <button type="submit">Save User</button>
  <button type="button" id="cancelUpdate" style="display:none;">Cancel Update</button>
</form>

<!-- Users Table -->

<table>
  <thead>
    <tr>
      <th>First Name</th>
      <th>Last Name</th>
      <th>Email</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="usersTableBody">
    <% if (typeof users !== 'undefined' && users.length > 0) { %>
      <% users.forEach(user => { %>
        <tr>
          <td><%= user.firstName %></td>
          <td><%= user.lastName %></td>
          <td><%= user.email %></td>
          <td>
            <button onclick="editUser('<%= user._id %>')">Edit</button>
            <button onclick="deleteUser('<%= user._id %>')">Delete</button>
          </td>
        </tr>
      <% }) %>
    <% } else { %>
      <tr><td colspan="4" style="text-align:center;">No users found</td></tr>
    <% } %>
  </tbody>
</table>

<script>
const API_URL = '/api/users';

// Load all users (if not rendered from server)
async function loadUsers() {
  try {
    const res = await fetch(API_URL);
    const users = await res.json();
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';
    users.forEach(user => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${user.firstName}</td>
        <td>${user.lastName}</td>
        <td>${user.email}</td>
        <td>
          <button onclick="editUser('${user._id}')">Edit</button>
          <button onclick="deleteUser('${user._id}')">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch (error) {
    console.error('Error loading users:', error);
  }
}

// Create or Update user
document.getElementById('userForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('userId').value;
  const userData = {
    firstName: document.getElementById('firstName').value,
    lastName: document.getElementById('lastName').value,
    email: document.getElementById('email').value,
    password: document.getElementById('password').value
  };

  const method = id ? 'PUT' : 'POST';
  const url = id ? `${API_URL}/${id}` : API_URL;

  await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(userData)
  });

  resetForm();
  loadUsers();
});

// Edit user
async function editUser(id) {
  const res = await fetch(`${API_URL}/${id}`);
  const user = await res.json();
  document.getElementById('userId').value = user._id;
  document.getElementById('firstName').value = user.firstName;
  document.getElementById('lastName').value = user.lastName;
  document.getElementById('email').value = user.email;
  document.getElementById('password').value = '';
  document.getElementById('cancelUpdate').style.display = 'inline';
}

// Cancel update
document.getElementById('cancelUpdate').addEventListener('click', () => {
  resetForm();
});

// Delete user
async function deleteUser(id) {
  if (confirm('Are you sure you want to delete this user?')) {
    await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
    loadUsers();
  }
}

// Reset form
function resetForm() {
  document.getElementById('userId').value = '';
  document.getElementById('firstName').value = '';
  document.getElementById('lastName').value = '';
  document.getElementById('email').value = '';
  document.getElementById('password').value = '';
  document.getElementById('cancelUpdate').style.display = 'none';
}

// Load users on page load if not pre-rendered
<% if (typeof users === 'undefined') { %>
loadUsers();
<% } %>
</script>

</body>
</html>
